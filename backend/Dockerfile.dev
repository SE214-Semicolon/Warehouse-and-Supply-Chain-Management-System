FROM node:20-alpine

WORKDIR /app

RUN npm install -g @nestjs/cli prisma

COPY package*.json ./

# Prepare permissions and install as non-root so node_modules is writable
RUN mkdir -p /app/node_modules && chown -R node:node /app
USER node
RUN npm install && npx prisma generate || true
USER root

COPY . .

EXPOSE 3000

# Run as non-root to avoid root-owned dist on host
USER node

CMD ["npm", "run", "start:dev"]
